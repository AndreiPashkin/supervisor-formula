machine:
  pre:
    - cat /etc/issue
    - sudo apt-get update
    - sudo apt-get install -t trusty-backports --force-yes -y lxc
  environment:
    CONTAINER: test
    SNAPSHOT: snap0

dependencies:
  pre:
    - pip install tox==2.3.1

test:
  override:
    - sudo lxc-create -t download -n ${CONTAINER}-base -- -d ubuntu -r trusty -a amd64
    - sudo lxc-clone -s ${CONTAINER}-base ${CONTAINER}
    - sudo lxc-start -n $CONTAINER
    - sleep 5
    - SALT_VERSION=2015.8 make provision
    - make copy-files
    - make snapshot
    - export SNAPSHOT=$(sudo lxc-snapshot -L -n test2 | cut -f1 -d ' ')
    - tox -v:
        timeout: 99999
  post:
    - while true; do sleep 10; done
